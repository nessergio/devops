name: Deploy Hello test App to AKS

trigger:
  - master

variables:
  - group: Infrastructure-Vars
  - name: dockerRegistryServiceConnection
    value: "acr-rbac-connection"
  - name: imageRepository
    value: "test"
  - name: TAG
    value: "$(Build.BuildId)"

pool:
  name: "Default"
  vmImage: "ubuntu-latest"

stages:
  - stage: Build
    displayName: "Build and Push Docker Image"
    jobs:
      - job: Build
        displayName: "Build Docker Image"
        steps:
          - task: Docker@2
            displayName: "Build Docker Image"
            inputs:
              command: build
              repository: $(imageRepository)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(TAG)
                latest

          - task: Docker@2
            displayName: "Push Docker Image to ACR"
            inputs:
              command: push
              repository: $(imageRepository)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(TAG)
                latest
